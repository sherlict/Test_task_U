with funnel_cte as (
select
    user_pseudo_id || value.int_value as unique_customer,
    item_name,
    count(distinct case when event_name = 'select_item' 
                            then user_pseudo_id || cast((case when event_params.key = 'ga_session_id' 
                                                              then value.int_value 
                                                              end) as string) 
                            end) as select_item_count,
        count(distinct case when event_name = 'view_item' 
                            then user_pseudo_id || cast((case when event_params.key = 'ga_session_id' 
                                                              then value.int_value 
                                                              end) as string) 
                            end) as view_item_count,
        count(distinct case when event_name = 'add_to_cart' 
                            then user_pseudo_id || cast((case when event_params.key = 'ga_session_id' 
                                                              then value.int_value 
                                                              end) as string) 
                            end) as add_to_cart_count,
        count(distinct case when event_name = 'purchase' 
                            then user_pseudo_id || cast((case when event_params.key = 'ga_session_id' 
                                                              then value.int_value 
                                                              end) as string) 
                            end) as purchase_count 
from `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`,
unnest(event_params) as event_params,
unnest(items) as items
where _table_suffix between '20200101' and '20201231'
group by
    unique_customer,
    item_name
)
select item_name,
       sum(select_item_count) as select_item_count,
       sum(view_item_count) as view_item_count,
       sum(add_to_cart_count) as add_to_cart_count,
       sum(purchase_count) as purchase_count
from funnel_cte
where select_item_count > 0 and item_name <> '(not set)'
group by item_name
